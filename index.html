<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת שאלונים מתקדמת</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9fafb;
        }
        .rtl {
            direction: rtl;
        }
        .max-w-screen-md {
            max-width: 768px;
        }
        .progress-bar {
            background-color: #e2e8f0;
            height: 0.5rem;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .progress-bar-fill {
            background-color: #4f46e5;
            height: 100%;
            transition: width 0.3s ease;
        }
        .hidden {
            display: none;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .button-primary:hover {
            background-color: #4338ca;
        }
        .button-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .button-secondary:hover {
            background-color: #d1d5db;
        }
        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .tab {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4f46e5;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #4f46e5;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .notification {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            background-color: #4f46e5;
            color: white;
            border-radius: 0.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(150%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        .notification.show {
            transform: translateY(0);
        }
        .radio-container {
            display: flex;
            margin-bottom: 0.5rem;
            align-items: flex-start;
        }
        .radio-container input[type="radio"] {
            margin-left: 0.5rem;
            margin-top: 0.25rem;
        }
        .radio-label {
            flex: 1;
        }
    </style>
</head>
<body class="rtl">
    <div class="container mx-auto px-4 py-8 max-w-screen-md">
        <h1 id="app-title" class="text-3xl font-bold text-center mb-8">מערכת שאלונים מתקדמת</h1>

        <!-- מסך בחירת מצב -->
        <div id="mode-selection" class="card">
            <h2 class="text-xl font-semibold mb-4">ברוכים הבאים למערכת השאלונים</h2>
            <div class="flex flex-col md:flex-row gap-4">
                <button id="admin-mode-btn" class="button-primary flex-1 text-center py-8">
                    <i class="fas fa-cog mb-2 text-2xl"></i>
                    <div>מנהל השאלון</div>
                    <div class="text-sm mt-2 opacity-80">יצירה, עריכה וניהול שאלונים</div>
                </button>
                <button id="user-mode-btn" class="button-primary flex-1 text-center py-8">
                    <i class="fas fa-edit mb-2 text-2xl"></i>
                    <div>מילוי שאלון</div>
                    <div class="text-sm mt-2 opacity-80">מענה על שאלון קיים</div>
                </button>
                <button id="one-time-mode-btn" class="button-primary flex-1 text-center py-8">
                    <i class="fas fa-file-upload mb-2 text-2xl"></i>
                    <div>טעינת שאלון חד פעמי</div>
                    <div class="text-sm mt-2 opacity-80">טעינה ומילוי שאלון מקובץ</div>
                </button>
                <button id="self-esteem-mode-btn" class="button-primary flex-1 text-center py-8">
                    <i class="fas fa-heart mb-2 text-2xl"></i>
                    <div>שאלון הערכה עצמית</div>
                    <div class="text-sm mt-2 opacity-80">מילוי שאלון הערכה עצמית מובנה</div>
                </button>
            </div>
        </div>

        <!-- מסך ניהול (אדמין) -->
        <div id="admin-panel" class="hidden">
            <div class="mb-4">
                <button id="back-to-mode-btn" class="button-secondary mb-4">
                    <i class="fas fa-arrow-right ml-1"></i>חזרה לבחירת מצב
                </button>
            </div>
            
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">ניהול שאלונים</h2>
                
                <div class="mb-6">
                    <div class="flex border-b">
                        <div id="new-questionnaire-tab" class="tab active">יצירת שאלון חדש</div>
                        <div id="edit-questionnaire-tab" class="tab">עריכת שאלון קיים</div>
                        <div id="import-questionnaire-tab" class="tab">טעינה מקובץ</div>
                        <div id="export-questionnaire-tab" class="tab">ייצוא לקובץ</div>
                    </div>
                </div>
                
                <!-- יצירת שאלון חדש -->
                <div id="new-questionnaire-panel">
                    <div class="mb-4">
                        <label class="block mb-2 font-medium">כותרת השאלון:</label>
                        <input type="text" id="questionnaire-title" class="input-field" placeholder="הזן כותרת">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block mb-2 font-medium">סוג תצוגה למשתמש:</label>
                        <div class="flex items-center mb-2">
                            <label class="switch mr-2">
                                <input type="checkbox" id="display-mode-toggle">
                                <span class="slider"></span>
                            </label>
                            <span id="display-mode-label">תצוגת היגדים מפורטים</span>
                        </div>
                        <div id="scale-options" class="hidden mt-4 p-4 bg-gray-50 rounded-md">
                            <h3 class="font-medium mb-2">הגדרת סולם אחיד:</h3>
                            <p class="text-sm text-gray-600 mb-4">הגדר את הערכים שיוצגו למשתמשים בסולם האחיד:</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                                <div>
                                    <label class="block text-sm">אפשרות 1:</label>
                                    <input type="text" id="scale-option-1" class="input-field" value="דומה לחלוטין">
                                </div>
                                <div>
                                    <label class="block text-sm">אפשרות 2:</label>
                                    <input type="text" id="scale-option-2" class="input-field" value="דומה">
                                </div>
                                <div>
                                    <label class="block text-sm">אפשרות 3:</label>
                                    <input type="text" id="scale-option-3" class="input-field" value="קצת דומה">
                                </div>
                                <div>
                                    <label class="block text-sm">אפשרות 4:</label>
                                    <input type="text" id="scale-option-4" class="input-field" value="לא כל כך דומה">
                                </div>
                                <div>
                                    <label class="block text-sm">אפשרות 5:</label>
                                    <input type="text" id="scale-option-5" class="input-field" value="בכלל לא דומה">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-medium mb-2">הגדרת פריטים והיגדים:</h3>
                        <p class="text-sm text-gray-600 mb-4">הגדר 20 פריטים, כל אחד עם 5 היגדים לבחירה:</p>
                        
                        <div id="items-accordion">
                            <!-- כאן יתווספו דינמית פריטי השאלון -->
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button id="save-questionnaire-btn" class="button-primary">
                            <i class="fas fa-save ml-1"></i>שמור הגדרות ויצור קוד שיתוף
                        </button>
                    </div>
                </div>
                
                <!-- עריכת שאלון קיים -->
                <div id="edit-questionnaire-panel" class="hidden">
                    <div class="mb-4">
                        <label class="block mb-2 font-medium">קוד שיתוף:</label>
                        <div class="flex">
                            <input type="text" id="edit-share-code" class="input-field" placeholder="הזן קוד שיתוף">
                            <button id="load-for-edit-btn" class="button-primary mr-2">טען</button>
                        </div>
                        <div id="recent-codes" class="text-sm mt-2">
                            <span class="text-gray-600">קודים אחרונים:</span>
                            <div id="recent-codes-list" class="flex flex-wrap gap-2 mt-1"></div>
                        </div>
                    </div>
                    
                    <div id="edit-form-container" class="hidden">
                        <!-- כאן יוצג טופס העריכה לאחר טעינת שאלון קיים -->
                    </div>
                </div>
                
                <!-- טעינה מקובץ -->
                <div id="import-questionnaire-panel" class="hidden">
                    <div class="mb-4">
                        <label class="block mb-2 font-medium">בחר קובץ JSON להעלאה:</label>
                        <input type="file" id="import-file" accept=".json" class="mb-4">
                        
                        <div class="p-4 bg-gray-50 rounded-md mb-4">
                            <h3 class="font-medium mb-2">מבנה קובץ JSON:</h3>
                            <pre class="text-xs overflow-auto bg-gray-100 p-2 rounded">
{
  "title": "כותרת השאלון",
  "displayMode": "detailed", // או "scale"
  "scaleOptions": ["דומה לחלוטין", "דומה", "קצת דומה", "לא כל כך דומה", "בכלל לא דומה"],
  "items": [
    {
      "question": "כותרת הפריט 1",
      "options": ["היגד 1", "היגד 2", "היגד 3", "היגד 4", "היגד 5"]
    },
    // עוד 19 פריטים
  ]
}
</pre>
                        </div>
                    </div>
                    
                    <div id="import-preview" class="hidden p-4 bg-gray-50 rounded-md mb-4">
                        <h3 class="font-medium mb-2">תצוגה מקדימה:</h3>
                        <div id="import-preview-content"></div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button id="process-import-btn" class="button-primary hidden">
                            <i class="fas fa-file-import ml-1"></i>טען שאלון
                        </button>
                    </div>
                </div>
                
                <!-- ייצוא לקובץ -->
                <div id="export-questionnaire-panel" class="hidden">
                    <div class="mb-4">
                        <label class="block mb-2 font-medium">קוד שיתוף:</label>
                        <div class="flex">
                            <input type="text" id="export-share-code" class="input-field" placeholder="הזן קוד שיתוף">
                            <button id="load-for-export-btn" class="button-primary mr-2">טען שאלון לייצוא</button>
                        </div>
                    </div>
                    
                    <div id="export-preview" class="hidden p-4 bg-gray-50 rounded-md mb-4">
                        <h3 class="font-medium mb-2">תצוגה מקדימה של השאלון לייצוא:</h3>
                        <div id="export-preview-content"></div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button id="export-btn" class="button-primary hidden">
                            <i class="fas fa-file-export ml-1"></i>ייצא לקובץ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- פאנל שיתוף -->
            <div id="share-panel" class="hidden card">
                <h2 class="text-xl font-semibold mb-4">שיתוף השאלון</h2>
                
                <div class="mb-4">
                    <label class="block mb-2 font-medium">קוד שיתוף:</label>
                    <div class="flex">
                        <input type="text" id="share-code" class="input-field" readonly>
                        <button id="copy-code-btn" class="button-secondary mr-2">
                            <i class="fas fa-copy ml-1"></i>העתק
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block mb-2 font-medium">קישור ישיר:</label>
                    <div class="flex">
                        <input type="text" id="share-link" class="input-field" readonly>
                        <button id="copy-link-btn" class="button-secondary mr-2">
                            <i class="fas fa-copy ml-1"></i>העתק
                        </button>
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button id="back-to-admin-btn" class="button-secondary">
                        <i class="fas fa-arrow-right ml-1"></i>חזרה לניהול
                    </button>
                    <button id="go-to-questionnaire-btn" class="button-primary">
                        <i class="fas fa-external-link-alt ml-1"></i>עבור לשאלון
                    </button>
                </div>
            </div>
        </div>
        
        <!-- מסך טעינת שאלון חד פעמי -->
        <div id="one-time-panel" class="hidden">
            <div class="mb-4">
                <button id="back-to-mode-from-one-time-btn" class="button-secondary mb-4">
                    <i class="fas fa-arrow-right ml-1"></i>חזרה לבחירת מצב
                </button>
            </div>
            
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">טעינת שאלון חד פעמי</h2>
                
                <div class="mb-4">
                    <label class="block mb-2 font-medium">בחר קובץ JSON של השאלון:</label>
                    <input type="file" id="one-time-import-file" accept=".json" class="mb-4">
                    
                    <div class="p-4 bg-gray-50 rounded-md mb-4">
                        <h3 class="font-medium mb-2">מבנה קובץ JSON:</h3>
                        <pre class="text-xs overflow-auto bg-gray-100 p-2 rounded">
{
  "title": "כותרת השאלון",
  "displayMode": "detailed", // או "scale"
  "scaleOptions": ["דומה לחלוטין", "דומה", "קצת דומה", "לא כל כך דומה", "בכלל לא דומה"],
  "items": [
    {
      "question": "כותרת הפריט 1",
      "options": ["היגד 1", "היגד 2", "היגד 3", "היגד 4", "היגד 5"]
    },
    // עוד 19 פריטים
  ]
}
</pre>
                    </div>
                </div>
                
                <div id="one-time-preview" class="hidden p-4 bg-gray-50 rounded-md mb-4">
                    <h3 class="font-medium mb-2">תצוגה מקדימה:</h3>
                    <div id="one-time-preview-content"></div>
                </div>
                
                <div class="flex justify-end">
                    <button id="start-one-time-questionnaire-btn" class="button-primary hidden">
                        <i class="fas fa-play ml-1"></i>התחל למלא שאלון
                    </button>
                </div>
            </div>
        </div>
        
        <!-- מסך כניסה לשאלון (כמשתמש) -->
        <div id="user-enter-panel" class="hidden">
            <div class="mb-4">
                <button id="back-to-mode-from-user-btn" class="button-secondary mb-4">
                    <i class="fas fa-arrow-right ml-1"></i>חזרה לבחירת מצב
                </button>
            </div>
            
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">כניסה לשאלון</h2>
                
                <div class="mb-4">
                    <label class="block mb-2 font-medium">קוד שיתוף:</label>
                    <div class="flex">
                        <input type="text" id="user-share-code" class="input-field" placeholder="הזן קוד שיתוף">
                        <button id="enter-questionnaire-btn" class="button-primary mr-2">היכנס לשאלון</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- מסך השאלון עצמו -->
        <div id="questionnaire-panel" class="hidden">
            <div class="mb-4">
                <button id="back-to-user-enter-btn" class="button-secondary mb-4">
                    <i class="fas fa-arrow-right ml-1"></i>חזרה למסך הכניסה
                </button>
            </div>
            
            <div class="card">
                <h2 id="questionnaire-title-display" class="text-xl font-semibold mb-4"></h2>
                
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>התקדמות:</span>
                        <span id="progress-text">0/20</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div id="questionnaire-items-container">
                    <!-- כאן יוצגו פריטי השאלון -->
                </div>
                
                <div class="flex justify-between mt-4">
                    <button id="prev-item-btn" class="button-secondary hidden">
                        <i class="fas fa-arrow-right ml-1"></i>הקודם
                    </button>
                    <button id="next-item-btn" class="button-primary">
                        הבא<i class="fas fa-arrow-left mr-1"></i>
                    </button>
                    <button id="download-results-btn" class="button-primary hidden">
                        <i class="fas fa-download ml-1"></i>הורד תוצאות
                    </button>
                    <button id="ai-analysis-btn" class="button-primary hidden">
                        <i class="fas fa-robot ml-1"></i>קבל ניתוח מבינה מלאכותית
                    </button>
                </div>
            </div>
        </div>
        
        <!-- מסך ניתוח AI -->
        <div id="ai-analysis-panel" class="hidden">
            <div class="mb-4">
                <button id="back-to-questionnaire-from-ai-btn" class="button-secondary mb-4">
                    <i class="fas fa-arrow-right ml-1"></i>חזרה לשאלון
                </button>
            </div>
            
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">ניתוח מבינה מלאכותית</h2>
                
                <div id="ai-analysis-content" class="prose max-w-none">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p>מנתח את התשובות שלך...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- מסך שאלון הערכה עצמית -->
        <div id="self-esteem-panel" class="hidden">
            <div class="mb-4">
                <button id="back-to-mode-from-self-esteem-btn" class="button-secondary mb-4">
                    <i class="fas fa-arrow-right ml-1"></i>חזרה לבחירת מצב
                </button>
            </div>
            
            <div class="card">
                <h2 class="text-xl font-semibold mb-4">שאלון הערכה עצמית</h2>
                
                <div class="mb-4">
                    <p class="text-gray-600 mb-4">שאלון זה נועד להערכת תחושות, מחשבות והתנהגויות הקשורות להערכה עצמית.</p>
                    <p class="text-gray-600 mb-4">אנא ענה בכנות על כל שאלה, תוך התחשבות בתחושותיך הנוכחיות.</p>
                </div>
                
                <div class="flex justify-end">
                    <button id="start-self-esteem-btn" class="button-primary">
                        <i class="fas fa-play ml-1"></i>התחל למלא שאלון
                    </button>
                </div>
            </div>
        </div>
        
        <!-- הודעת התראה -->
        <div id="notification" class="notification">
            <span id="notification-text"></span>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // אתחול משתנים גלובליים
            const NUM_ITEMS = 20;
            const NUM_OPTIONS = 5;
            let currentQuestionnaireData = null;
            let currentItemIndex = 0;
            let userAnswers = Array(NUM_ITEMS).fill(null);
            
            // אחסון קודי שיתוף אחרונים
            let recentCodes = JSON.parse(localStorage.getItem('recentCodes')) || [];
            
            // מצביעים לאלמנטים בדום
            const modeSelection = document.getElementById('mode-selection');
            const adminPanel = document.getElementById('admin-panel');
            const userEnterPanel = document.getElementById('user-enter-panel');
            const questionnairePanel = document.getElementById('questionnaire-panel');
            const sharePanel = document.getElementById('share-panel');
            const oneTimePanel = document.getElementById('one-time-panel');
            const selfEsteemPanel = document.getElementById('self-esteem-panel');
            
            const newQuestionnaireTab = document.getElementById('new-questionnaire-tab');
            const editQuestionnaireTab = document.getElementById('edit-questionnaire-tab');
            const importQuestionnaireTab = document.getElementById('import-questionnaire-tab');
            const exportQuestionnaireTab = document.getElementById('export-questionnaire-tab');
            
            const newQuestionnairePanel = document.getElementById('new-questionnaire-panel');
            const editQuestionnairePanel = document.getElementById('edit-questionnaire-panel');
            const importQuestionnairePanel = document.getElementById('import-questionnaire-panel');
            const exportQuestionnairePanel = document.getElementById('export-questionnaire-panel');
            
            const itemsAccordion = document.getElementById('items-accordion');
            const displayModeToggle = document.getElementById('display-mode-toggle');
            const displayModeLabel = document.getElementById('display-mode-label');
            const scaleOptions = document.getElementById('scale-options');
            
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notification-text');
            
            // יצירת תוכן ברירת מחדל לפריטים והיגדים
            function createDefaultItems() {
                const items = [];
                for (let i = 0; i < NUM_ITEMS; i++) {
                    items.push({
                        question: `פריט ${i + 1}`,
                        options: Array(NUM_OPTIONS).fill('').map((_, j) => `היגד ${j + 1} לפריט ${i + 1}`)
                    });
                }
                return items;
            }
            
            // יצירת ברירת מחדל לסולם האחיד
            const defaultScaleOptions = [
                "דומה לחלוטין",
                "דומה",
                "קצת דומה",
                "לא כל כך דומה",
                "בכלל לא דומה"
            ];
            
            // פונקציה ליצירת פריט אקורדיון
            function createItemAccordion(item, index) {
                const accordionItem = document.createElement('div');
                accordionItem.className = 'mb-2 border rounded';
                
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center p-3 bg-gray-50 cursor-pointer';
                header.innerHTML = `
                    <h4 class="font-medium">פריט ${index + 1}</h4>
                    <i class="fas fa-chevron-down"></i>
                `;
                
                const content = document.createElement('div');
                content.className = 'p-3 border-t hidden';
                
                let contentHtml = `
                    <div class="mb-3">
                        <label class="block mb-1 text-sm font-medium">כותרת/שאלה:</label>
                        <input type="text" class="input-field" id="item-question-${index}" value="${item.question || ''}">
                    </div>
                    <div>
                        <label class="block mb-1 text-sm font-medium">היגדים לבחירה:</label>
                `;
                
                for (let i = 0; i < NUM_OPTIONS; i++) {
                    contentHtml += `
                        <div class="mb-2">
                            <label class="block mb-1 text-xs">היגד ${i + 1}:</label>
                            <input type="text" class="input-field" id="item-option-${index}-${i}" value="${item.options[i] || ''}">
                        </div>
                    `;
                }
                
                content.innerHTML = contentHtml + '</div>';
                
                accordionItem.appendChild(header);
                accordionItem.appendChild(content);
                
                // אירוע לחיצה על הכותרת
                header.addEventListener('click', function() {
                    const isHidden = content.classList.contains('hidden');
                    
                    // סגירת כל הפריטים הפתוחים
                    const allContents = itemsAccordion.querySelectorAll('.border-t');
                    const allIcons = itemsAccordion.querySelectorAll('.fa-chevron-up');
                    
                    allContents.forEach(cont => cont.classList.add('hidden'));
                    allIcons.forEach(icon => icon.classList.replace('fa-chevron-up', 'fa-chevron-down'));
                    
                    // פתיחת הפריט הנוכחי
                    if (isHidden) {
                        content.classList.remove('hidden');
                        header.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up');
                    }
                });
                
                return accordionItem;
            }
            
            // יצירת פריטי אקורדיון ברירת מחדל
            function populateItemsAccordion(items) {
                itemsAccordion.innerHTML = '';
                items.forEach((item, index) => {
                    const accordionItem = createItemAccordion(item, index);
                    itemsAccordion.appendChild(accordionItem);
                });
            }
            
            // איסוף נתוני השאלון מהטופס
            function collectQuestionnaireData() {
                const title = document.getElementById('questionnaire-title').value || 'שאלון חדש';
                const displayMode = displayModeToggle.checked ? 'scale' : 'detailed';
                
                const scaleOptionsArr = [];
                if (displayMode === 'scale') {
                    for (let i = 1; i <= NUM_OPTIONS; i++) {
                        const option = document.getElementById(`scale-option-${i}`).value;
                        scaleOptionsArr.push(option || defaultScaleOptions[i - 1]);
                    }
                }
                
                const items = [];
                for (let i = 0; i < NUM_ITEMS; i++) {
                    const question = document.getElementById(`item-question-${i}`).value || `פריט ${i + 1}`;
                    const options = [];
                    
                    for (let j = 0; j < NUM_OPTIONS; j++) {
                        const option = document.getElementById(`item-option-${i}-${j}`).value || `היגד ${j + 1} לפריט ${i + 1}`;
                        options.push(option);
                    }
                    
                    items.push({ question, options });
                }
                
                return {
                    title,
                    displayMode,
                    scaleOptions: scaleOptionsArr.length ? scaleOptionsArr : defaultScaleOptions,
                    items
                };
            }
            
            // פופולציה של טופס העריכה מנתוני שאלון
            function populateEditForm(data) {
                const editFormContainer = document.getElementById('edit-form-container');
                
                let html = `
                    <div class="mb-4">
                        <label class="block mb-2 font-medium">כותרת השאלון:</label>
                        <input type="text" id="edit-questionnaire-title" class="input-field" value="${data.title || ''}">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block mb-2 font-medium">סוג תצוגה למשתמש:</label>
                        <div class="flex items-center mb-2">
                            <label class="switch mr-2">
                                <input type="checkbox" id="edit-display-mode-toggle" ${data.displayMode === 'scale' ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <span id="edit-display-mode-label">${data.displayMode === 'scale' ? 'תצוגת סולם אחיד' : 'תצוגת היגדים מפורטים'}</span>
                        </div>
                        <div id="edit-scale-options" class="${data.displayMode === 'scale' ? '' : 'hidden'} mt-4 p-4 bg-gray-50 rounded-md">
                            <h3 class="font-medium mb-2">הגדרת סולם אחיד:</h3>
                            <p class="text-sm text-gray-600 mb-4">הגדר את הערכים שיוצגו למשתמשים בסולם האחיד:</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                `;
                
                for (let i = 0; i < NUM_OPTIONS; i++) {
                    const optionValue = data.scaleOptions && data.scaleOptions[i] ? data.scaleOptions[i] : defaultScaleOptions[i];
                    html += `
                        <div>
                            <label class="block text-sm">אפשרות ${i + 1}:</label>
                            <input type="text" id="edit-scale-option-${i + 1}" class="input-field" value="${optionValue}">
                        </div>
                    `;
                }
                
                html += `
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="font-medium mb-2">הגדרת פריטים והיגדים:</h3>
                        <p class="text-sm text-gray-600 mb-4">הגדר 20 פריטים, כל אחד עם 5 היגדים לבחירה:</p>
                        
                        <div id="edit-items-accordion">
                `;
                
                data.items.forEach((item, index) => {
                    html += `
                        <div class="mb-2 border rounded">
                            <div class="flex justify-between items-center p-3 bg-gray-50 cursor-pointer edit-accordion-header">
                                <h4 class="font-medium">פריט ${index + 1}</h4>
                                <i class="fas fa-chevron-down"></i>
                            </div>
                            <div class="p-3 border-t hidden edit-accordion-content">
                                <div class="mb-3">
                                    <label class="block mb-1 text-sm font-medium">כותרת/שאלה:</label>
                                    <input type="text" class="input-field" id="edit-item-question-${index}" value="${item.question || ''}">
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm font-medium">היגדים לבחירה:</label>
                    `;
                    
                    for (let i = 0; i < NUM_OPTIONS; i++) {
                        html += `
                            <div class="mb-2">
                                <label class="block mb-1 text-xs">היגד ${i + 1}:</label>
                                <input type="text" class="input-field" id="edit-item-option-${index}-${i}" value="${item.options[i] || ''}">
                            </div>
                        `;
                    }
                    
                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                    
                    <div class="flex justify-end">
                        <button id="update-questionnaire-btn" class="button-primary">
                            <i class="fas fa-save ml-1"></i>שמור שינויים
                        </button>
                    </div>
                `;
                
                editFormContainer.innerHTML = html;
                editFormContainer.classList.remove('hidden');
                
                // הוספת מאזינים לכותרות האקורדיון
                document.querySelectorAll('.edit-accordion-header').forEach(header => {
                    header.addEventListener('click', function() {
                        const content = this.nextElementSibling;
                        const isHidden = content.classList.contains('hidden');
                        
                        // סגירת כל הפריטים הפתוחים
                        const allContents = document.querySelectorAll('.edit-accordion-content');
                        const allIcons = document.querySelectorAll('.edit-accordion-header i');
                        
                        allContents.forEach(cont => cont.classList.add('hidden'));
                        allIcons.forEach(icon => icon.classList.replace('fa-chevron-up', 'fa-chevron-down'));
                        
                        // פתיחת הפריט הנוכחי
                        if (isHidden) {
                            content.classList.remove('hidden');
                            this.querySelector('i').classList.replace('fa-chevron-down', 'fa-chevron-up');
                        }
                    });
                });
                
                // מאזין למתג סוג התצוגה
                const editDisplayModeToggle = document.getElementById('edit-display-mode-toggle');
                const editDisplayModeLabel = document.getElementById('edit-display-mode-label');
                const editScaleOptions = document.getElementById('edit-scale-options');
                
                editDisplayModeToggle.addEventListener('change', function() {
                    if (this.checked) {
                        editDisplayModeLabel.textContent = 'תצוגת סולם אחיד';
                        editScaleOptions.classList.remove('hidden');
                    } else {
                        editDisplayModeLabel.textContent = 'תצוגת היגדים מפורטים';
                        editScaleOptions.classList.add('hidden');
                    }
                });
                
                // מאזין לכפתור עדכון
                document.getElementById('update-questionnaire-btn').addEventListener('click', function() {
                    const updatedData = collectEditedQuestionnaireData();
                    const shareCode = document.getElementById('edit-share-code').value;
                    
                    // שמירת הנתונים המעודכנים
                    localStorage.setItem(`questionnaire_${shareCode}`, JSON.stringify(updatedData));
                    
                    showNotification('השאלון עודכן בהצלחה!');
                });
            }
            
            // איסוף נתוני השאלון מטופס העריכה
            function collectEditedQuestionnaireData() {
                const title = document.getElementById('edit-questionnaire-title').value || 'שאלון מעודכן';
                const displayMode = document.getElementById('edit-display-mode-toggle').checked ? 'scale' : 'detailed';
                
                const scaleOptionsArr = [];
                if (displayMode === 'scale') {
                    for (let i = 1; i <= NUM_OPTIONS; i++) {
                        const option = document.getElementById(`edit-scale-option-${i}`).value;
                        scaleOptionsArr.push(option || defaultScaleOptions[i - 1]);
                    }
                }
                
                const items = [];
                for (let i = 0; i < NUM_ITEMS; i++) {
                    const question = document.getElementById(`edit-item-question-${i}`).value || `פריט ${i + 1}`;
                    const options = [];
                    
                    for (let j = 0; j < NUM_OPTIONS; j++) {
                        const option = document.getElementById(`edit-item-option-${i}-${j}`).value || `היגד ${j + 1} לפריט ${i + 1}`;
                        options.push(option);
                    }
                    
                    items.push({ question, options });
                }
                
                return {
                    title,
                    displayMode,
                    scaleOptions: scaleOptionsArr.length ? scaleOptionsArr : defaultScaleOptions,
                    items
                };
            }
            
            // יצירת קוד שיתוף אקראי
            function generateShareCode() {
                return Math.random().toString(36).substring(2, 10);
            }
            
            // הצגת התראה למשתמש
            function showNotification(message) {
                notificationText.textContent = message;
                notification.classList.add('show');
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // הוספת קוד שיתוף לרשימת האחרונים
            function addToRecentCodes(code) {
                // הסרת הקוד אם כבר קיים
                recentCodes = recentCodes.filter(c => c !== code);
                
                // הוספת הקוד בתחילת המערך
                recentCodes.unshift(code);
                
                // שמירה של עד 5 קודים אחרונים
                if (recentCodes.length > 5) {
                    recentCodes = recentCodes.slice(0, 5);
                }
                
                // שמירה בלוקל סטורג'
                localStorage.setItem('recentCodes', JSON.stringify(recentCodes));
                
                // עדכון התצוגה
                updateRecentCodesList();
            }
            
            // עדכון רשימת הקודים האחרונים בתצוגה
            function updateRecentCodesList() {
                const recentCodesList = document.getElementById('recent-codes-list');
                recentCodesList.innerHTML = '';
                
                recentCodes.forEach(code => {
                    const codeBtn = document.createElement('button');
                    codeBtn.className = 'text-blue-600 hover:underline';
                    codeBtn.textContent = code;
                    codeBtn.addEventListener('click', function() {
                        document.getElementById('edit-share-code').value = code;
                    });
                    
                    recentCodesList.appendChild(codeBtn);
                });
            }
            
            // יצירת פריטי השאלון בתצוגת המשתמש
            function createQuestionnaireItems(data) {
                const container = document.getElementById('questionnaire-items-container');
                container.innerHTML = '';
                
                // ריקון תשובות המשתמש
                userAnswers = Array(NUM_ITEMS).fill(null);
                
                // עדכון כותרת השאלון
                document.getElementById('questionnaire-title-display').textContent = data.title;
                
                // יצירת פריטים
                data.items.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'questionnaire-item mb-6 p-4 border rounded-md hidden';
                    itemDiv.id = `questionnaire-item-${index}`;
                    
                    let html = `<h3 class="font-medium mb-3">${item.question}</h3>`;
                    
                    // תצוגת היגדים רגילה
                    if (data.displayMode === 'detailed') {
                        item.options.forEach((option, optIndex) => {
                            html += `
                                <div class="radio-container">
                                    <input type="radio" id="option-${index}-${optIndex}" name="item-${index}" value="${optIndex}">
                                    <label class="radio-label" for="option-${index}-${optIndex}">${option}</label>
                                </div>
                            `;
                        });
                    } 
                    // תצוגת סולם אחיד
                    else {
                        data.scaleOptions.forEach((scaleOption, optIndex) => {
                            html += `
                                <div class="radio-container">
                                    <input type="radio" id="option-${index}-${optIndex}" name="item-${index}" value="${optIndex}">
                                    <label class="radio-label" for="option-${index}-${optIndex}">${scaleOption}</label>
                                </div>
                            `;
                        });
                    }
                    
                    itemDiv.innerHTML = html;
                    container.appendChild(itemDiv);
                    
                    // הוספת מאזיני רדיו
                    itemDiv.querySelectorAll('input[type="radio"]').forEach(radio => {
                        radio.addEventListener('change', function() {
                            userAnswers[index] = parseInt(this.value);
                            updateProgressBar();
                        });
                    });
                });
                
                // הצגת הפריט הראשון
                document.getElementById(`questionnaire-item-${0}`).classList.remove('hidden');
            }
            
            // עדכון פס ההתקדמות
            function updateProgressBar() {
                const answeredCount = userAnswers.filter(ans => ans !== null).length;
                const progressPercent = (answeredCount / NUM_ITEMS) * 100;
                
                document.getElementById('progress-bar-fill').style.width = `${progressPercent}%`;
                document.getElementById('progress-text').textContent = `${answeredCount}/${NUM_ITEMS}`;
                
                // הפעלת כפתור ההורדה אם הושלם הכל
                if (answeredCount === NUM_ITEMS) {
                    document.getElementById('download-results-btn').classList.remove('hidden');
                } else {
                    document.getElementById('download-results-btn').classList.add('hidden');
                }
            }
            
            // מעבר לפריט הבא או הקודם
            function navigateItems(direction) {
                // הסתרת הפריט הנוכחי
                document.getElementById(`questionnaire-item-${currentItemIndex}`).classList.add('hidden');
                
                // עדכון האינדקס
                currentItemIndex += direction;
                
                // הצגת הפריט החדש
                document.getElementById(`questionnaire-item-${currentItemIndex}`).classList.remove('hidden');
                
                // עדכון כפתורי הניווט
                updateNavigationButtons();
            }
            
            // עדכון כפתורי הניווט בשאלון
            function updateNavigationButtons() {
                const prevBtn = document.getElementById('prev-item-btn');
                const nextBtn = document.getElementById('next-item-btn');
                const downloadBtn = document.getElementById('download-results-btn');
                
                // כפתור קודם
                if (currentItemIndex > 0) {
                    prevBtn.classList.remove('hidden');
                } else {
                    prevBtn.classList.add('hidden');
                }
                
                // כפתור הבא/סיים
                if (currentItemIndex === NUM_ITEMS - 1) {
                    nextBtn.classList.add('hidden');
                    
                    // הצגת כפתור הורדה אם כל השאלות מולאו
                    if (userAnswers.every(ans => ans !== null)) {
                        downloadBtn.classList.remove('hidden');
                    } else {
                        downloadBtn.classList.add('hidden');
                    }
                } else {
                    nextBtn.classList.remove('hidden');
                    downloadBtn.classList.add('hidden');
                }
            }
            
            // הורדת תוצאות השאלון
            function downloadResults() {
                if (!userAnswers.every(ans => ans !== null)) {
                    showNotification('נא למלא את כל הפריטים לפני הורדת התוצאות');
                    return;
                }
                
                // יצירת תוכן הקובץ
                let fileContent = `${currentQuestionnaireData.title}\n\n`;
                
                userAnswers.forEach((answerIndex, itemIndex) => {
                    // הוספת ההיגד שנבחר
                    const selectedOption = currentQuestionnaireData.items[itemIndex].options[answerIndex];
                    fileContent += `${selectedOption}\n`;
                });
                
                // יצירת הקובץ והורדתו
                const blob = new Blob([fileContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                a.href = url;
                a.download = `תוצאות_${currentQuestionnaireData.title.replace(/\s+/g, '_')}.txt`;
                document.body.appendChild(a);
                a.click();
                
                // ניקוי
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
            
            // אתחול המערכת
            function initializeApp() {
                // אתחול פריטי השאלון ברירת מחדל
                populateItemsAccordion(createDefaultItems());
                
                // מאזין למתג סוג התצוגה
                displayModeToggle.addEventListener('change', function() {
                    if (this.checked) {
                        displayModeLabel.textContent = 'תצוגת סולם אחיד';
                        scaleOptions.classList.remove('hidden');
                    } else {
                        displayModeLabel.textContent = 'תצוגת היגדים מפורטים';
                        scaleOptions.classList.add('hidden');
                    }
                });
                
                // עדכון רשימת הקודים האחרונים
                updateRecentCodesList();
                
                // מאזיני אירועים למעברים בין מסכים
                
                // חזרה למסך הבחירה ממסך המנהל
                document.getElementById('back-to-mode-btn').addEventListener('click', function() {
                    adminPanel.classList.add('hidden');
                    modeSelection.classList.remove('hidden');
                });
                
                // מעבר למסך המנהל
                document.getElementById('admin-mode-btn').addEventListener('click', function() {
                    modeSelection.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                });
                
                // מעבר למסך המשתמש
                document.getElementById('user-mode-btn').addEventListener('click', function() {
                    modeSelection.classList.add('hidden');
                    userEnterPanel.classList.remove('hidden');
                });

                // חזרה למסך הבחירה ממסך הכניסה למשתמש
                document.getElementById('back-to-mode-from-user-btn').addEventListener('click', function() {
                    userEnterPanel.classList.add('hidden');
                    modeSelection.classList.remove('hidden');
                });

                // מעבר למסך טעינת שאלון חד פעמי
                document.getElementById('one-time-mode-btn').addEventListener('click', function() {
                    modeSelection.classList.add('hidden');
                    oneTimePanel.classList.remove('hidden');
                });
                
                // חזרה למסך הבחירה ממסך טעינת שאלון חד פעמי
                document.getElementById('back-to-mode-from-one-time-btn').addEventListener('click', function() {
                    oneTimePanel.classList.add('hidden');
                    modeSelection.classList.remove('hidden');
                });

                // מעבר למסך שאלון הערכה עצמית
                document.getElementById('self-esteem-mode-btn').addEventListener('click', function() {
                    modeSelection.classList.add('hidden');
                    selfEsteemPanel.classList.remove('hidden');
                });

                // חזרה למסך הבחירה ממסך שאלון הערכה עצמית
                document.getElementById('back-to-mode-from-self-esteem-btn').addEventListener('click', function() {
                    selfEsteemPanel.classList.add('hidden');
                    modeSelection.classList.remove('hidden');
                });

                // התחלת שאלון הערכה עצמית
                document.getElementById('start-self-esteem-btn').addEventListener('click', function() {
                    // טעינת הקובץ SelfEsteem1.json
                    fetch('SelfEsteem1.json')
                        .then(response => response.json())
                        .then(data => {
                            // שמירת הנתונים זמנית
                            currentQuestionnaireData = data;
                            
                            // איפוס מיקום בשאלון
                            currentItemIndex = 0;
                            
                            // יצירת פריטי השאלון
                            createQuestionnaireItems(data);
                            
                            // איפוס פס ההתקדמות
                            updateProgressBar();
                            
                            // עדכון כפתורי הניווט
                            updateNavigationButtons();
                            
                            // מעבר למסך השאלון
                            selfEsteemPanel.classList.add('hidden');
                            questionnairePanel.classList.remove('hidden');
                            
                            showNotification('השאלון נטען בהצלחה');
                        })
                        .catch(error => {
                            console.error('Error loading questionnaire:', error);
                            showNotification('שגיאה בטעינת השאלון');
                        });
                });
                
                // מאזיני אירועים לטאבים
                newQuestionnaireTab.addEventListener('click', function() {
                    activateTab(this, newQuestionnairePanel);
                });
                
                editQuestionnaireTab.addEventListener('click', function() {
                    activateTab(this, editQuestionnairePanel);
                });
                
                importQuestionnaireTab.addEventListener('click', function() {
                    activateTab(this, importQuestionnairePanel);
                });
                
                exportQuestionnaireTab.addEventListener('click', function() {
                    activateTab(this, exportQuestionnairePanel);
                });
                
                // מאזין לכפתור שמירה ויצירת קוד שיתוף
                document.getElementById('save-questionnaire-btn').addEventListener('click', function() {
                    const questionnaireData = collectQuestionnaireData();
                    const shareCode = generateShareCode();
                    
                    // שמירה בלוקל סטורג'
                    localStorage.setItem(`questionnaire_${shareCode}`, JSON.stringify(questionnaireData));
                    
                    // הוספה לרשימת הקודים האחרונים
                    addToRecentCodes(shareCode);
                    
                    // הצגת פאנל השיתוף
                    document.getElementById('share-code').value = shareCode;
                    
                    const currentUrl = window.location.href.split('?')[0];
                    document.getElementById('share-link').value = `${currentUrl}?code=${shareCode}`;
                    
                    adminPanel.classList.add('hidden');
                    sharePanel.classList.remove('hidden');
                });
                
                // מאזין לכפתור העתקת קוד
                document.getElementById('copy-code-btn').addEventListener('click', function() {
                    const shareCode = document.getElementById('share-code');
                    shareCode.select();
                    document.execCommand('copy');
                    showNotification('הקוד הועתק ללוח');
                });
                
                // מאזין לכפתור העתקת קישור
                document.getElementById('copy-link-btn').addEventListener('click', function() {
                    const shareLink = document.getElementById('share-link');
                    shareLink.select();
                    document.execCommand('copy');
                    showNotification('הקישור הועתק ללוח');
                });
                
                // מאזין לכפתור טעינת שאלון לעריכה
                document.getElementById('load-for-edit-btn').addEventListener('click', function() {
                    const shareCode = document.getElementById('edit-share-code').value;
                    if (!shareCode) {
                        showNotification('נא להזין קוד שיתוף');
                        return;
                    }
                    
                    const questionnaireData = localStorage.getItem(`questionnaire_${shareCode}`);
                    if (!questionnaireData) {
                        showNotification('לא נמצא שאלון עם הקוד שהוזן');
                        return;
                    }
                    
                    // טעינת הנתונים לטופס העריכה
                    const data = JSON.parse(questionnaireData);
                    populateEditForm(data);
                    
                    // הוספה לרשימת הקודים האחרונים
                    addToRecentCodes(shareCode);
                });
                
                // מאזין להעלאת קובץ
                document.getElementById('import-file').addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // בדיקת תקינות מבנה הקובץ
                            if (!validateQuestionnaireData(data)) {
                                showNotification('מבנה הקובץ אינו תקין');
                                return;
                            }
                            
                            // הצגת תצוגה מקדימה
                            displayImportPreview(data);
                            
                            // הצגת כפתור הטעינה
                            document.getElementById('process-import-btn').classList.remove('hidden');
                            
                        } catch (err) {
                            console.error(err);
                            showNotification('שגיאה בטעינת הקובץ');
                        }
                    };
                    reader.onerror = function() {
                        showNotification('שגיאה בקריאת הקובץ');
                    };
                    reader.readAsText(file);
                });
                
                // מאזין לכפתור טעינת שאלון לעריכה
                document.getElementById('process-import-btn').addEventListener('click', function() {
                    const importPreviewContent = document.getElementById('import-preview-content');
                    if (!importPreviewContent.dataset.questionnaireData) {
                        showNotification('לא נמצאו נתוני שאלון לטעינה');
                        return;
                    }

                    try {
                        const data = JSON.parse(importPreviewContent.dataset.questionnaireData);
                        
                        // יצירת קוד שיתוף חדש
                        const shareCode = generateShareCode();
                        
                        // שמירה בלוקל סטורג'
                        localStorage.setItem(`questionnaire_${shareCode}`, JSON.stringify(data));
                        
                        // הוספה לרשימת הקודים האחרונים
                        addToRecentCodes(shareCode);
                        
                        // הצגת פאנל השיתוף
                        document.getElementById('share-code').value = shareCode;
                        
                        const currentUrl = window.location.href.split('?')[0];
                        document.getElementById('share-link').value = `${currentUrl}?code=${shareCode}`;
                        
                        // הסתרת פאנל המנהל והצגת פאנל השיתוף
                        adminPanel.classList.add('hidden');
                        sharePanel.classList.remove('hidden');
                        
                        // איפוס תצוגת הייבוא
                        document.getElementById('import-file').value = '';
                        document.getElementById('import-preview').classList.add('hidden');
                        document.getElementById('process-import-btn').classList.add('hidden');
                        
                        showNotification('השאלון נטען בהצלחה');
                    } catch (err) {
                        console.error(err);
                        showNotification('שגיאה בעיבוד נתוני השאלון');
                    }
                });
                
                // מאזין לכפתור טעינת שאלון לייצוא
                document.getElementById('load-for-export-btn').addEventListener('click', function() {
                    const shareCode = document.getElementById('export-share-code').value;
                    if (!shareCode) {
                        showNotification('נא להזין קוד שיתוף');
                        return;
                    }
                    
                    const questionnaireData = localStorage.getItem(`questionnaire_${shareCode}`);
                    if (!questionnaireData) {
                        showNotification('לא נמצא שאלון עם הקוד שהוזן');
                        return;
                    }
                    
                    // הצגת תצוגה מקדימה
                    const data = JSON.parse(questionnaireData);
                    displayExportPreview(data);
                    
                    // הצגת כפתור הייצוא
                    document.getElementById('export-btn').classList.remove('hidden');
                    
                    // הוספה לרשימת הקודים האחרונים
                    addToRecentCodes(shareCode);
                });
                
                // מאזין לכפתור ייצוא לקובץ
                document.getElementById('export-btn').addEventListener('click', function() {
                    const exportPreviewContent = document.getElementById('export-preview-content');
                    const data = JSON.parse(exportPreviewContent.dataset.questionnaireData);
                    
                    // יצירת הקובץ והורדתו
                    const jsonString = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonString], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    
                    a.href = url;
                    a.download = `${data.title.replace(/\s+/g, '_')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    
                    // ניקוי
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                    
                    showNotification('הקובץ הורד בהצלחה');
                });
                
                // מאזין לכפתור כניסה לשאלון
                document.getElementById('enter-questionnaire-btn').addEventListener('click', function() {
                    const shareCode = document.getElementById('user-share-code').value;
                    if (!shareCode) {
                        showNotification('נא להזין קוד שיתוף');
                        return;
                    }
                    
                    // טעינת השאלון
                    if (loadQuestionnaire(shareCode)) {
                        userEnterPanel.classList.add('hidden');
                        questionnairePanel.classList.remove('hidden');
                    }
                });
                
                // מאזינים לכפתורי ניווט בשאלון
                document.getElementById('prev-item-btn').addEventListener('click', function() {
                    navigateItems(-1);
                });
                
                document.getElementById('next-item-btn').addEventListener('click', function() {
                    navigateItems(1);
                });
                
                document.getElementById('download-results-btn').addEventListener('click', function() {
                    downloadResults();
                });
                
                // מאזין לכפתור חזרה למסך הכניסה
                document.getElementById('back-to-user-enter-btn').addEventListener('click', function() {
                    questionnairePanel.classList.add('hidden');
                    userEnterPanel.classList.remove('hidden');
                });
                
                // בדיקה אם יש קוד בפרמטרים של הURL
                checkUrlForShareCode();
            }
            
            // פונקציה להפעלת טאב
            function activateTab(tabElement, panelElement) {
                // הסרת הקלאס אקטיב מכל הטאבים
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                
                // הוספת הקלאס אקטיב לטאב הנוכחי
                tabElement.classList.add('active');
                
                // הסתרת כל הפאנלים
                document.getElementById('new-questionnaire-panel').classList.add('hidden');
                document.getElementById('edit-questionnaire-panel').classList.add('hidden');
                document.getElementById('import-questionnaire-panel').classList.add('hidden');
                document.getElementById('export-questionnaire-panel').classList.add('hidden');
                
                // הצגת הפאנל המתאים
                panelElement.classList.remove('hidden');
            }
            
            // בדיקת תקינות מבנה הקובץ
            function validateQuestionnaireData(data) {
                if (!data.title || !data.items || !Array.isArray(data.items)) {
                    return false;
                }
                
                if (data.items.length !== NUM_ITEMS) {
                    return false;
                }
                
                for (const item of data.items) {
                    if (!item.question || !item.options || !Array.isArray(item.options) || item.options.length !== NUM_OPTIONS) {
                        return false;
                    }
                }
                
                if (data.displayMode === 'scale' && (!data.scaleOptions || !Array.isArray(data.scaleOptions) || data.scaleOptions.length !== NUM_OPTIONS)) {
                    return false;
                }
                
                return true;
            }
            
            // הצגת תצוגה מקדימה לקובץ מיובא
            function displayImportPreview(data) {
                const previewElement = document.getElementById('import-preview');
                const previewContent = document.getElementById('import-preview-content');
                
                let html = `
                    <div class="mb-2"><strong>כותרת:</strong> ${data.title}</div>
                    <div class="mb-2"><strong>סוג תצוגה:</strong> ${data.displayMode === 'scale' ? 'סולם אחיד' : 'היגדים מפורטים'}</div>
                `;
                
                if (data.displayMode === 'scale') {
                    html += `<div class="mb-2"><strong>אפשרויות סולם:</strong> ${data.scaleOptions.join(', ')}</div>`;
                }
                
                html += `<div class="mb-2"><strong>מספר פריטים:</strong> ${data.items.length}</div>`;
                
                previewContent.innerHTML = html;
                previewContent.dataset.questionnaireData = JSON.stringify(data);
                
                previewElement.classList.remove('hidden');
            }
            
            // הצגת תצוגה מקדימה לשאלון לייצוא
            function displayExportPreview(data) {
                const previewElement = document.getElementById('export-preview');
                const previewContent = document.getElementById('export-preview-content');
                
                let html = `
                    <div class="mb-2"><strong>כותרת:</strong> ${data.title}</div>
                    <div class="mb-2"><strong>סוג תצוגה:</strong> ${data.displayMode === 'scale' ? 'סולם אחיד' : 'היגדים מפורטים'}</div>
                `;
                
                if (data.displayMode === 'scale') {
                    html += `<div class="mb-2"><strong>אפשרויות סולם:</strong> ${data.scaleOptions.join(', ')}</div>`;
                }
                
                html += `<div class="mb-2"><strong>מספר פריטים:</strong> ${data.items.length}</div>`;
                
                previewContent.innerHTML = html;
                previewContent.dataset.questionnaireData = JSON.stringify(data);
                
                previewElement.classList.remove('hidden');
            }
            
            // טעינת שאלון לפי קוד שיתוף
            function loadQuestionnaire(shareCode) {
                const questionnaireData = localStorage.getItem(`questionnaire_${shareCode}`);
                if (!questionnaireData) {
                    showNotification('לא נמצא שאלון עם הקוד שהוזן');
                    return false;
                }
                
                // טעינת הנתונים
                currentQuestionnaireData = JSON.parse(questionnaireData);
                
                // איפוס מיקום בשאלון
                currentItemIndex = 0;
                
                // יצירת פריטי השאלון
                createQuestionnaireItems(currentQuestionnaireData);
                
                // איפוס פס ההתקדמות
                updateProgressBar();
                
                // עדכון כפתורי הניווט
                updateNavigationButtons();
                
                return true;
            }
            
            // בדיקה אם יש קוד בפרמטרים של הURL
            function checkUrlForShareCode() {
                const urlParams = new URLSearchParams(window.location.search);
                const shareCode = urlParams.get('code');
                
                if (shareCode) {
                    // אם יש קוד, להיכנס ישירות למצב מילוי שאלון
                    document.getElementById('user-share-code').value = shareCode;
                    
                    // טעינת השאלון
                    if (loadQuestionnaire(shareCode)) {
                        modeSelection.classList.add('hidden');
                        questionnairePanel.classList.remove('hidden');
                    }
                }
            }
            
            // הצגת תצוגה מקדימה לשאלון חד פעמי
            function displayOneTimePreview(data) {
                const previewElement = document.getElementById('one-time-preview');
                const previewContent = document.getElementById('one-time-preview-content');
                
                let html = `
                    <div class="mb-2"><strong>כותרת:</strong> ${data.title}</div>
                    <div class="mb-2"><strong>סוג תצוגה:</strong> ${data.displayMode === 'scale' ? 'סולם אחיד' : 'היגדים מפורטים'}</div>
                `;
                
                if (data.displayMode === 'scale') {
                    html += `<div class="mb-2"><strong>אפשרויות סולם:</strong> ${data.scaleOptions.join(', ')}</div>`;
                }
                
                html += `<div class="mb-2"><strong>מספר פריטים:</strong> ${data.items.length}</div>`;
                
                previewContent.innerHTML = html;
                previewContent.dataset.questionnaireData = JSON.stringify(data);
                
                previewElement.classList.remove('hidden');
            }

            // מאזין להעלאת קובץ חד פעמי
            document.getElementById('one-time-import-file').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // בדיקת תקינות מבנה הקובץ
                        if (!validateQuestionnaireData(data)) {
                            showNotification('מבנה הקובץ אינו תקין');
                            return;
                        }
                        
                        // הצגת תצוגה מקדימה
                        displayOneTimePreview(data);
                        
                        // הצגת כפתור התחלת השאלון
                        const startButton = document.getElementById('start-one-time-questionnaire-btn');
                        startButton.classList.remove('hidden');
                        
                    } catch (err) {
                        console.error(err);
                        showNotification('שגיאה בטעינת הקובץ');
                    }
                };
                reader.onerror = function() {
                    showNotification('שגיאה בקריאת הקובץ');
                };
                reader.readAsText(file);
            });

            // מאזין לכפתור התחלת שאלון חד פעמי
            document.getElementById('start-one-time-questionnaire-btn').addEventListener('click', function() {
                const previewContent = document.getElementById('one-time-preview-content');
                if (!previewContent.dataset.questionnaireData) {
                    showNotification('לא נמצאו נתוני שאלון לטעינה');
                    return;
                }

                try {
                    const data = JSON.parse(previewContent.dataset.questionnaireData);
                    
                    // שמירת הנתונים זמנית
                    currentQuestionnaireData = data;
                    
                    // איפוס מיקום בשאלון
                    currentItemIndex = 0;
                    
                    // יצירת פריטי השאלון
                    createQuestionnaireItems(data);
                    
                    // איפוס פס ההתקדמות
                    updateProgressBar();
                    
                    // עדכון כפתורי הניווט
                    updateNavigationButtons();
                    
                    // מעבר למסך השאלון
                    oneTimePanel.classList.add('hidden');
                    questionnairePanel.classList.remove('hidden');
                    
                    showNotification('השאלון נטען בהצלחה');
                } catch (err) {
                    console.error(err);
                    showNotification('שגיאה בעיבוד נתוני השאלון');
                }
            });
            
            // מאזין להעלאת קובץ חד פעמי
            document.getElementById('one-time-import-file').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // בדיקת תקינות מבנה הקובץ
                        if (!validateQuestionnaireData(data)) {
                            showNotification('מבנה הקובץ אינו תקין');
                            return;
                        }
                        
                        // הצגת תצוגה מקדימה
                        displayOneTimePreview(data);
                        
                        // הצגת כפתור התחלת השאלון
                        const startButton = document.getElementById('start-one-time-questionnaire-btn');
                        startButton.classList.remove('hidden');
                        
                    } catch (err) {
                        console.error(err);
                        showNotification('שגיאה בטעינת הקובץ');
                    }
                };
                reader.onerror = function() {
                    showNotification('שגיאה בקריאת הקובץ');
                };
                reader.readAsText(file);
            });

            // מאזין לכפתור התחלת שאלון חד פעמי
            document.getElementById('start-one-time-questionnaire-btn').addEventListener('click', function() {
                const previewContent = document.getElementById('one-time-preview-content');
                if (!previewContent.dataset.questionnaireData) {
                    showNotification('לא נמצאו נתוני שאלון לטעינה');
                    return;
                }

                try {
                    const data = JSON.parse(previewContent.dataset.questionnaireData);
                    
                    // שמירת הנתונים זמנית
                    currentQuestionnaireData = data;
                    
                    // איפוס מיקום בשאלון
                    currentItemIndex = 0;
                    
                    // יצירת פריטי השאלון
                    createQuestionnaireItems(data);
                    
                    // איפוס פס ההתקדמות
                    updateProgressBar();
                    
                    // עדכון כפתורי הניווט
                    updateNavigationButtons();
                    
                    // מעבר למסך השאלון
                    oneTimePanel.classList.add('hidden');
                    questionnairePanel.classList.remove('hidden');
                    
                    showNotification('השאלון נטען בהצלחה');
                } catch (err) {
                    console.error(err);
                    showNotification('שגיאה בעיבוד נתוני השאלון');
                }
            });
            
            // אתחול
            initializeApp();
            
            // מאזין לכפתור ניתוח AI
            document.getElementById('ai-analysis-btn').addEventListener('click', async function() {
                if (!userAnswers.every(ans => ans !== null)) {
                    showNotification('נא למלא את כל הפריטים לפני קבלת ניתוח');
                    return;
                }
                
                // יצירת תוכן הקובץ
                let fileContent = `${currentQuestionnaireData.title}\n\n`;
                
                userAnswers.forEach((answerIndex, itemIndex) => {
                    // הוספת ההיגד שנבחר
                    const selectedOption = currentQuestionnaireData.items[itemIndex].options[answerIndex];
                    fileContent += `${selectedOption}\n`;
                });
                
                // מעבר למסך הניתוח
                questionnairePanel.classList.add('hidden');
                document.getElementById('ai-analysis-panel').classList.remove('hidden');
                
                try {
                    // שליחת הנתונים ל-Claude
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': 'YOUR_ANTHROPIC_API_KEY', // יש להחליף במפתח API אמיתי
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-sonnet-20240229',
                            max_tokens: 1000,
                            messages: [{
                                role: 'user',
                                content: `אנא נתח את התשובות הבאות לשאלון הערכה עצמית:\n\n${fileContent}`
                            }]
                        })
                    });
                    
                    const data = await response.json();
                    
                    // הצגת התשובה
                    const aiAnalysisContent = document.getElementById('ai-analysis-content');
                    aiAnalysisContent.innerHTML = data.content[0].text;
                    
                } catch (error) {
                    console.error('Error getting AI analysis:', error);
                    showNotification('שגיאה בקבלת הניתוח מבינה מלאכותית');
                }
            });
            
            // מאזין לכפתור חזרה מהניתוח לשאלון
            document.getElementById('back-to-questionnaire-from-ai-btn').addEventListener('click', function() {
                document.getElementById('ai-analysis-panel').classList.add('hidden');
                questionnairePanel.classList.remove('hidden');
            });
        });
    </script>
</body>
</html>
